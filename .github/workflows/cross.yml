# .github/workflows/cross_build_parallel.yml
name: Rust 跨平台并行编译发布 (c-* tag触发 | 零语法错误)

# 触发条件：仅推送 c- 开头的Tag执行
on:
  push:
    tags:
      - 'c-*'

# 全局权限：创建Release+上传产物
permissions:
  contents: write

jobs:
  # 步骤1：前置准备 - 提取Tag版本号 (只执行1次，全局复用)
  prepare:
    name: 提取版本号并剥离c-前缀
    runs-on: ubuntu-latest
    outputs:
      TAG_NAME: ${{ steps.tag.outputs.TAG_NAME }}
      TAG_RAW: ${{ steps.tag.outputs.TAG_RAW }}
    steps:
      - id: tag
        run: |
          TAG_RAW="${{ github.ref_name }}"
          TAG_NAME="${TAG_RAW#c-}"
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "TAG_RAW=${TAG_RAW}" >> $GITHUB_OUTPUT

  # 步骤2：核心并行编译 - 合规的matrix矩阵写法（无任何语法错误）
  build:
    name: 编译 ${{ matrix.target }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # 单个平台失败，不影响其他平台编译（核心）
      matrix:
        # ✅ 核心修复：纯静态矩阵项，只定义静态值，不引用任何matrix变量，彻底合规
        target:
          - x86_64-unknown-linux-musl
          - x86_64-pc-windows-gnu
          - x86_64-pc-windows-msvc
          - x86_64-apple-darwin
          - aarch64-apple-darwin
        # ✅ 为每个target匹配对应的后缀和编译工具，无变量引用，合规！
        include:
          - target: x86_64-unknown-linux-musl
            exe_suffix: ""
            use_zig: false
          - target: x86_64-pc-windows-gnu
            exe_suffix: ".exe"
            use_zig: false
          - target: x86_64-pc-windows-msvc
            exe_suffix: ".exe"
            use_zig: false
          - target: x86_64-apple-darwin
            exe_suffix: ""
            use_zig: true
          - target: aarch64-apple-darwin
            exe_suffix: ""
            use_zig: true

    steps:
      - name: 检出项目源码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装Rust稳定版 + 当前平台工具链
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: 安装Ubuntu编译依赖（极简必备，无多余包）
        run: |
          sudo apt update && sudo apt install -y build-essential musl-tools mingw-w64 gcc-mingw-w64-x86-64
          sudo apt clean

      - name: 【按需安装】仅macOS编译时安装 cargo-zigbuild (无多余步骤，提速)
        if: matrix.use_zig == true
        run: cargo install cargo-zigbuild

      - name: 缓存Cargo依赖 (每个平台独立缓存，提速80%+)
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: ./ -> target
          key: ${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: 执行编译命令 (✅ 合规：在steps里使用matrix变量，完美规避语法错误)
        run: |
          if [ "${{ matrix.use_zig }}" = "true" ]; then
            cargo zigbuild --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi

      - name: 产物瘦身 (无损压缩，体积减小50%+)
        run: strip ./target/${{ matrix.target }}/release/rust-m3u8${{ matrix.exe_suffix }}

      - name: 创建产物目录 + 严格按你的规则重命名文件
        run: |
          mkdir -p ./release-artifacts
          cp ./target/${{ matrix.target }}/release/rust-m3u8${{ matrix.exe_suffix }} \
             ./release-artifacts/rust-m3u8-${{ matrix.target }}-${{ needs.prepare.outputs.TAG_NAME }}${{ matrix.exe_suffix }}

      - name: 上传当前平台产物到临时仓库
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: ./release-artifacts/
          retention-days: 90
