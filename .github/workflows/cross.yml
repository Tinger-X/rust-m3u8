name: 主流平台编译

on:
  push:
    tags:
      - "c-*"  # temp `cross build` tags

jobs:
  build:
    name: ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # 主流操作系统 - 保留你的原版配置
        os: [windows-latest, ubuntu-latest, macos-latest]
        # 主流架构 - 保留你的原版配置
        arch: [x86_64, aarch64]
        # 排除不可能的组合 - 保留你的原版配置
        exclude:
          - os: windows-latest
            arch: aarch64
        # ✅ 核心修复：为每一个合法的os+arch组合，绑定对应的标准Rust编译Target
        # 这是解决target传参为空的唯一方法，也是根治GLIBC的关键
        include:
          - os: ubuntu-latest
            arch: x86_64
            target: x86_64-unknown-linux-musl  # 静态编译，彻底脱离GLIBC依赖
          - os: windows-latest
            arch: x86_64
            target: x86_64-pc-windows-msvc      # Windows原生编译目标
          - os: macos-latest
            arch: x86_64
            target: x86_64-apple-darwin         # Mac Intel原生编译目标
          - os: macos-latest
            arch: aarch64
            target: aarch64-apple-darwin        # Mac M1/M2/M3原生编译目标

    steps:
      - uses: actions/checkout@v4
      
      # ✅ 修复这里的传参：原来是 matrix.target.triple 改为 matrix.target
      - name: "编译代码"
        uses: dtolnay/rust-toolchain@stable
        with:
          target: ${{ matrix.target }}

      # ✅ Ubuntu专属：安装musl静态编译依赖（根治GLIBC必须，其他系统无需）
      - name: 安装Ubuntu musl编译依赖
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt update && sudo apt install -y musl-tools && sudo apt clean -y

      # ✅ 编译命令 + 体积优化环境变量：--release + 指定target + 编译期瘦身
      - run: cargo build --release --target ${{ matrix.target }}
        env:
          # 编译优化：减小体积，不损失任何性能，编译期剥离调试符号
          RUSTFLAGS: "-C opt-level=3 -C strip=symbols -C debuginfo=0"
      
      # ✅ 完美保留你的原版pwsh脚本 + 修复产物路径 + 新增全平台产物瘦身（体积再减20%-40%）
      - name: 准备产物
        run: |
          # 修复产物路径：指定target后，产物在 target/目标名/release 目录下
          $srcPath = "target/${{ matrix.target }}/release/"
          $srcExe = $srcPath + "rust-m3u8.exe"
          $srcBin = $srcPath + "rust-m3u8"
          $dstName = "rust-m3u8-${{ matrix.os }}-${{ matrix.arch }}"

          # 保留你原版的判断逻辑：区分Windows和其他系统
          if ("${{ matrix.os }}" -eq "windows-latest") {
            Copy-Item $srcExe "$dstName.exe" -Force
            # Windows瘦身：使用rust自带的llvm-strip，无原生strip工具
            llvm-strip "$dstName.exe"
          } else {
            Copy-Item $srcBin $dstName -Force
            # Linux/Mac瘦身：原生strip工具，极致减小体积
            if ("${{ matrix.os }}" -eq "ubuntu-latest") { strip -s $dstName }
            if ("${{ matrix.os }}" -eq "macos-latest") { strip -S $dstName }
          }
          # 查看瘦身後的体积
          ls -lh $dstName*
        shell: pwsh

      # ✅ 完全保留你的原版上传产物配置，一字未改
      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: rust-m3u8-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            ./rust-m3u8-*
            !target/release/*.d