name: 主流平台编译

on:
  push:
    tags:
      - "c-*"

jobs:
  build:
    name: ${{ matrix.label }}
    runs-on: ${{ matrix.run_os }}
    strategy:
      fail-fast: false # 单个平台失败不影响其他平台
      matrix:
        include:
          # Windows x86_64 - 兼容Win10/Win11 全系版本，无依赖
          - run_os: windows-latest
            os: windows
            arch: x86_64
            target: x86_64-pc-windows-msvc
            label: windows-x86_64
          # Linux x86_64 静态编译 - 无GLIBC依赖，兼容Ubuntu18/20/22/24+全Linux发行版
          - run_os: ubuntu-latest
            os: linux
            arch: x86_64
            target: x86_64-unknown-linux-musl
            label: linux-x86_64
          # Linux aarch64 静态编译 - ARM64架构Linux设备通用
          - run_os: ubuntu-latest
            os: linux
            arch: aarch64
            target: aarch64-unknown-linux-musl
            label: linux-aarch64
          # MacOS x86_64 - Intel芯片Mac (2020及以前机型)
          - run_os: macos-latest
            os: macos
            arch: x86_64
            target: x86_64-apple-darwin
            label: macos-x86_64
          # MacOS aarch64 - M1/M2/M3芯片Mac (2021+全系新Mac)
          - run_os: macos-latest
            os: macos
            arch: aarch64
            target: aarch64-apple-darwin
            label: macos-aarch64

    steps:
      - name: 拉取项目源码
        uses: actions/checkout@v4

      - name: 缓存Cargo依赖包
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          target: ${{ matrix.target }}

      - name: 配置Rust编译环境+指定目标架构
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Linux 安装 openssl/musl
        if: startsWith(matrix.run_os, 'ubuntu')
        run: sudo apt update -y && sudo apt install -y musl-tools libssl-dev pkg-config

      - name: MacOS 安装 openssl
        if: startsWith(matrix.run_os, 'macos')
        run: brew install openssl@3 pkg-config && echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      - name: Windows 安装 openssl
        if: startsWith(matrix.run_os, 'windows')
        run: vcpkg install openssl:x64-windows && echo "OPENSSL_DIR=C:\vcpkg\installed\x64-windows" >> $env:GITHUB_ENV
        shell: pwsh

      - name: 执行Release模式编译
        run: cargo build --release --target ${{ matrix.target }}

      - name: 产物重命名
        shell: pwsh
        run: |
          # 核心：PowerShell正则去掉tag开头的c-前缀，如 c-v1.0.0 → v1.0.0
          $RAW_TAG = "${{ github.ref_name }}"
          $CLEAN_TAG = $RAW_TAG -replace '^c-', ''
          
          # 变量定义
          $OS = "${{ matrix.os }}"
          $ARCH = "${{ matrix.arch }}"
          $BINARY_BASE = "rust-m3u8"
          $TARGET_DIR = "${{ matrix.target }}"
          $SRC_PATH = "target/$TARGET_DIR/release/"

          # ✅ 严格按你的要求生成产物名：rust-m3u8-${系统}-${架构}-${纯净tag名}[.exe]
          $FINAL_NAME = "$BINARY_BASE-$OS-$ARCH-$CLEAN_TAG"

          # 分系统处理后缀和复制
          if ($OS -eq "windows") {
              Copy-Item -Path "$SRC_PATH$BINARY_BASE.exe" -Destination "$FINAL_NAME.exe" -Force
              Write-Host "✅ Windows产物生成成功: $FINAL_NAME.exe"
          } else {
              Copy-Item -Path "$SRC_PATH$BINARY_BASE" -Destination "$FINAL_NAME" -Force
              chmod +x $FINAL_NAME # Linux/Mac赋执行权限
              Write-Host "✅ 产物生成成功: $FINAL_NAME"
          }

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.label }}
          path: |
            rust-m3u8-*
            !rust-m3u8-*.d