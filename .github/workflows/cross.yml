# .github/workflows/cross_build.yml
name: Rust-M3U8 跨平台编译

on:
  push:
    tags:
      - 'c-*'

jobs:
  cross-compile:
    name: 跨平台编译
    runs-on: ubuntu-latest
    permissions:
      contents: write # 上传产物权限
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装Rust稳定版及目标平台
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: |
            x86_64-unknown-linux-musl
            x86_64-pc-windows-gnu
            x86_64-pc-windows-msvc
            x86_64-apple-darwin
            aarch64-apple-darwin

      - name: 安装Ubuntu基础依赖
        run: |
          sudo apt update && sudo apt install -y build-essential musl-tools mingw-w64 gcc-mingw-w64-x86-64
          sudo apt clean

      - name: 缓存Cargo依赖
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: ./ -> target

      # ✅ 核心步骤1：安装 cross + 启动Docker服务
      - name: 安装 cross 工具 (解决原生依赖交叉编译问题)
        run: cargo install cross --git https://github.com/cross-rs/cross

      # ✅ 无兼容问题的TAG提取+剥离前缀
      - name: 初始化环境变量
        run: |
          TAG_RAW="${{ github.ref_name }}"
          TAG_NAME="${TAG_RAW#c-}"
          echo "TAG_RAW=${TAG_RAW}" >> $GITHUB_ENV
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
          mkdir -p ./artifacts

      # 用 cross build 替换 cargo build
      # ✅ 编译1: Linux x64 静态链接版
      - name: 编译 Linux x86_64 musl
        run: |
          cross build --release --target x86_64-unknown-linux-musl
          strip ./target/x86_64-unknown-linux-musl/release/rust-m3u8
          cp ./target/x86_64-unknown-linux-musl/release/rust-m3u8 ./artifacts/rust-m3u8-x86_64-unknown-linux-musl-${{ env.TAG_NAME }}

      # ✅ 编译2: Windows x64 MinGW版 (.exe)
      - name: 编译 Windows x64 gnu
        run: |
          cross build --release --target x86_64-pc-windows-gnu
          strip ./target/x86_64-pc-windows-gnu/release/rust-m3u8.exe
          cp ./target/x86_64-pc-windows-gnu/release/rust-m3u8.exe ./artifacts/rust-m3u8-x86_64-pc-windows-gnu-${{ env.TAG_NAME }}.exe

      # ✅ 编译3: Windows x64 MSVC原生版 (.exe，性能更好)
      - name: 编译 Windows x64 msvc
        run: |
          cross build --release --target x86_64-pc-windows-msvc
          strip ./target/x86_64-pc-windows-msvc/release/rust-m3u8.exe
          cp ./target/x86_64-pc-windows-msvc/release/rust-m3u8.exe ./artifacts/rust-m3u8-x86_64-pc-windows-msvc-${{ env.TAG_NAME }}.exe

      # ✅ 编译4: macOS x64 (Intel芯片) - cross自动处理macOS SDK+openssl依赖
      - name: 编译 macOS x86_64 (Intel)
        run: |
          cross build --release --target x86_64-apple-darwin
          strip ./target/x86_64-apple-darwin/release/rust-m3u8
          cp ./target/x86_64-apple-darwin/release/rust-m3u8 ./artifacts/rust-m3u8-x86_64-apple-darwin-${{ env.TAG_NAME }}

      # ✅ 编译5: macOS ARM64 (M1/M2/M3芯片)
      - name: 编译 macOS aarch64 (Apple Silicon)
        run: |
          cross build --release --target aarch64-apple-darwin
          strip ./target/aarch64-apple-darwin/release/rust-m3u8
          cp ./target/aarch64-apple-darwin/release/rust-m3u8 ./artifacts/rust-m3u8-aarch64-apple-darwin-${{ env.TAG_NAME }}

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: rust-m3u8-cross-build-${{ env.TAG_NAME }}
          path: ./artifacts/
          retention-days: 90
